(function(a,e){var c=function(){};c.prototype={editor:null,siteUrl:null,title:null,image:null,spinner:null,SelectedNode:null,addButtonAndRegisterCommand:function(f){this.editor.addCommand(this.command,function(){f()});this.editor.addButton(this.id,{title:this.title,image:this.image,cmd:this.command})},loadStyleSheet:function(k,g,l){var h=document.getElementsByTagName("head")[0];var j=document.createElement("link");j.setAttribute("href",k);j.setAttribute("rel","stylesheet");j.setAttribute("type","text/css");var m,f;if("sheet" in j){m="sheet";f="cssRules"}else{m="styleSheet";f="rules"}var i=setInterval(function(){try{if(j[m]&&j[m][f].length){clearInterval(i);clearTimeout(n);g.call(l||window,true,j)}}catch(o){}finally{}},10);var n=setTimeout(function(){clearInterval(i);clearTimeout(n);h.removeChild(j);g.call(l||window,false,j)},15000);h.appendChild(j);return j},_scriptLoaderCallbacks:{},loadScript:function(j,l,g,h){var k=this;if(!l()){if(!this._scriptLoaderCallbacks[j]){this._scriptLoaderCallbacks[j]=function(){g.call(h||window,true)}}else{var f=this._scriptLoaderCallbacks[j];this._scriptLoaderCallbacks[j]=function(){f();g.call(h||window,true)};return}var i=new tinymce.dom.ScriptLoader();i.load(j);i.loadQueue(function(){if(!l()){throw"Failed verify that script is loaded "+j}var m=k._scriptLoaderCallbacks[j];k._scriptLoaderCallbacks[j]=null;m()})}else{g.call(h||window,false)}},loadJSON:function(f,h){var g=function(){try{return JSON&&JSON.stringify&&JSON.parse}catch(i){return false}};this.loadScript(this.editor.settings.imagevault_imageVaultEPiServerCmsBaseUrl+"Scripts/JSON2.js",g,function(){f.call(h||window)},this)},_loadjQuerySession:{noOfRequest:0,oldjQuery:null,old$:null},loadjQuery:function(f,h){var i=this;var g=function(){return(jQuery&&jQuery.fn.jquery=="1.6.1")||(window.iv_jQuery&&window.iv_jQuery.fn.jquery=="1.6.1")};this.loadJSON(function(){this.loadScript(this.editor.settings.imagevault_imageVaultEPiServerCmsBaseUrl+"Scripts/jquery-1.6.1.min.js",g,function(j){this._loadjQuerySession.noOfRequest++;if(this._loadjQuerySession.noOfRequest==1){if(!j){if(typeof window.iv_jQuery==="undefined"||!window.iv_jQuery){window.iv_jQuery=window.jQuery}if(window.iv_jQuery.fn.jquery!="1.6.1"){throw"Wrong version of jQuery found as window.iv_jQuery, Expected 1.6.1, actual "+window.iv_jQuery.fn.jquery}this._loadjQuerySession.oldjQuery=window.jQuery;this._loadjQuerySession.old$=window.$;window.jQuery=window.$=window.iv_jQuery}}f.call(h||window,function(){i._loadjQuerySession.noOfRequest--;if(i._loadjQuerySession.noOfRequest==0){if(j){window.iv_jQuery=jQuery.noConflict(true)}else{window.iv_jQuery=window.jQuery;window.jQuery=i._loadjQuerySession.oldjQuery;window.$=i._loadjQuerySession.old$}}})},this)},this)},loadSpinner:function(f,g){this.loadjQuery(function(h){var i=function(){return typeof Spinner==="function"};this.loadScript(this.editor.settings.imagevault_imageVaultEPiServerCmsBaseUrl+"Scripts/spin-min.js",i,function(){h();f.call(g||window)})},this)},loadClient:function(f,h){var g=function(){return window.ImageVault&&window.ImageVault.Client};this.loadjQuery(function(i){this.loadScript(this.editor.settings.imagevault_imageVaultEPiServerCmsBaseUrl+"Scripts/ImageVault.Client.js",g,function(){i();f.call(h||window)},this)},this)},loadPropertyMediaCommon:function(f,h){var g=function(){return ImageVault&&ImageVault.PropertyMediaCommon};this.loadFancyBox(function(i){this.loadScript(this.editor.settings.imagevault_imageVaultEPiServerCmsBaseUrl+"Scripts/ImageVault.PropertyMediaCommon.js",g,function(j){i();if(j){if(!ImageVault.PropertyMediaCommon.ivUiAuthUrl){ImageVault.PropertyMediaCommon.ivUiAuthUrl=this.editor.settings.imagevault_ivUiAuthUrl}if(!ImageVault.PropertyMediaCommon.editorUri){ImageVault.PropertyMediaCommon.editorUri=this.editor.settings.imagevault_editorUri}if(!ImageVault.PropertyMediaCommon.mediaUrlBase){ImageVault.PropertyMediaCommon.mediaUrlBase=this.editor.settings.imagevault_mediaUrlBase}if(!ImageVault.PropertyMediaCommon.msg){ImageVault.PropertyMediaCommon.msg={editorWidthInputLabel:this.editor.settings.imagevault_pmcm_editorWidthInputLabel,editorHeightInputLabel:this.editor.settings.imagevault_pmcm_editorHeightInputLabel,editorOkButtonText:this.editor.settings.imagevault_pmcm_editorOkButtonText,editorCancelButtonText:this.editor.settings.imagevault_pmcm_editorCancelButtonText,editorWarningIconText:this.editor.settings.imagevault_pmcm_editorWarningIconText,editorReloadButtonText:this.editor.settings.imagevault_pmcm_editorReloadButtonText}}}f.call(h||window)},this);return true},this)},loadFancyBox:function(f,g){this.loadjQuery(function(h){if(a.browser.msie){if(!f.call(g||window,h)){h()}return}var i=function(){return window.iv_jQuery.fn.fancybox||window.jQuery.fn.fancybox};this.loadScript(this.editor.settings.imagevault_imageVaultEPiServerCmsBaseUrl+"Scripts/jquery.fancybox-1.3.4.pack.js",i,function(j){if(j){this.loadStyleSheet(this.editor.settings.imagevault_imageVaultEPiServerCmsBaseUrl+"Styles/jquery.fancybox-1.3.4.css",function(){if(!f.call(g||window,h)){h()}})}else{if(!f.call(g||window,h)){h()}}},this)},this)},getClient:function(f,g){this.loadClient(function(){if(!ImageVault.Client.Instance){ImageVault.Client.Instance=new ImageVault.Client({core:this.editor.settings.imagevault_ivCoreProxy,authMethod:"none"})}f.call(g||window,ImageVault.Client.Instance)},this)},isImageVaultUrl:function(f){if(/\/media\/[a-z,0-9]{20}\//i.test(f)){return true}if(/\/publishedmedia\/[a-z,0-9]{20}\//i.test(f)){return true}return false},showSpinner:function(f){this.loadSpinner(function(){if(this.spinner){this.hideSpinner()}var g={lines:13,length:8,width:3,radius:10,corners:1,rotate:0,color:"#222",speed:1,trail:60,shadow:true,hwaccel:true,className:"spinner",zIndex:2000000000,top:"auto",left:"auto"};this.spinner=new Spinner(g).spin(f.get(0))},this)},hideSpinner:function(){if(this.spinner){this.spinner.stop();this.spinner=null}},insertMedia:function(g){var j=this;if(this.SelectedNode){this.editor.selection.select(this.SelectedNode)}var f=function(l){j.editor.execCommand("mceInsertContent",false,l);j.editor.windowManager.onClose.dispatch()};if(this.editor.selection.getNode().nodeName.toUpperCase()=="IMG"){f=function(l){j.editor.execCommand("mceReplaceContent",false,l);j.editor.execCommand("mceRepaint");j.editor.windowManager.onClose.dispatch()}}var h=this.parseOriginalAndMedia(g);var i=h.SelectedMedia;if(i.ContentDisplayType==1){f(i.Html);return}var k=i.Url;f('<img src="'+k+'"/>');return},parseOriginalAndMedia:function(f){var g=null,h=null;if(!f||!f.MediaConversions||!f.MediaConversions.length){return null}if(this.isOriginalImageFormat(f.MediaConversions[0])){g=f.MediaConversions[0];if(f.MediaConversions.length>1){h=f.MediaConversions[1]}}else{if(f.MediaConversions.length==1||this.isOriginalImageFormat(f.MediaConversions[1])){if(f.MediaConversions.length>1){g=f.MediaConversions[1]}h=f.MediaConversions[0]}else{return null}}if(!h){h=g}return{OriginalMedia:g,SelectedMedia:h}},isOriginalImageFormat:function(f){if(f.FormatWidth||f.FormatHeight||f.FormatAspectRatio||(f.Effects&&f.Effects.length)){return false}return true}};var b=function(f){this.init(f)};a.extend(b.prototype,c.prototype);a.extend(b.prototype,{command:"openImageVault",id:"imagevaultButton",init:function(f){a.extend(this,f);var g=this;this.editor.onNodeChange.add(function(i,h,j){g.nodeChanged(i,h,j)});this.addButtonAndRegisterCommand(function(){g.openImageVault()})},nodeChanged:function(g,f,i){var h=false;i=g.selection.getNode();if(i&&i.nodeName&&i.nodeName.toLowerCase()=="img"){h=this.isImageVaultUrl(i.src)}f.setActive(this.id,h)},openImageVault:function(){var f=this;f.editor.windowManager.onOpen.dispatch();this.loadScript(this.editor.settings.imagevault_imageVaultEPiServerCmsBaseUrl+"Scripts/ImageVault.UICallback.js",function(){return window.ImageVault&&window.ImageVault.UiCallback&&window.ImageVault.UiCallback.Instance},function(){f.openImageVaultWhenScriptIsLoaded()})},_getWindowName:function(f){f=(f||"noname").replace(new RegExp("-","g"),"_");return f},openImageVaultWhenScriptIsLoaded:function(){var h="?PageLang="+this.editor.settings.epi_page_context.epslanguage;h+="&UiLang="+this.editor.getLang("imagevault.language","en");h+="&insertMultiple=false&FormatId=NA";h+="&EnsurePublishingSource="+encodeURIComponent(this.editor.settings.imagevault_publishIdentifier);h+="&MediaUrlBase="+encodeURIComponent(this.editor.settings.imagevault_mediaUrlBase);var g=this.editor.settings.imagevault_imageVaultUiBaseUrl;if(this.editor.settings.imagevault_imageVaultUiIsExternal){h+="&u="+encodeURIComponent(g);g=this.editor.settings.imagevault_imageVaultEPiServerCmsBaseUrl+"scripts/ivui.aspx"}var j=g+h;var f=this._getWindowName("fritext"+this.editor.id);var i=this;ImageVault.UiCallback.Instance.RegisterOpener(f,false,function(k){i.insertMedia(k)});window.open(j,f,"width=1034,height=768,resizable=yes,scrollbars")}});e.TinyMceAddButton=b;var d=function(f){this.init(f)};a.extend(d.prototype,c.prototype);a.extend(d.prototype,{command:"openImageVaultEditor",id:"imagevaultEditorButton",init:function(f){a.extend(this,f);var g=this;this.editor.onNodeChange.add(function(i,h,j){g.nodeChanged(i,h,j)});this.addButtonAndRegisterCommand(function(){g.openEditor()})},nodeChanged:function(g,f,i){var h=false;i=g.selection.getNode();if(i&&i.nodeName&&i.nodeName.toLowerCase()=="img"){h=this.isImageVaultUrl(i.src)}f.setActive(this.id,h);f.setDisabled(this.id,!h)},openEditor:function(){var g=this;var f=this.editor.selection.getNode();if(!f||!f.src){alert("No image selected");return}this.SelectedNode=f;g.editor.windowManager.onOpen.dispatch();this.showSpinner(a(this.editor.getContainer()).find(".mceIframeContainer"));this.getClient(function(h){var j={Filter:{Url:[f.src]},Populate:{MediaFormats:[{$type:"ImageVault.Common.Data.ImageFormat,ImageVault.Common"}]},MediaUrlBase:g.editor.settings.imagevault_mediaUrlBase};var i=JSON.stringify(j);h.json("MediaService/Find",i,function(m){if(!m||m.length!=1){var k=h.getLastErrorMessage();if(k){if(/no access/i.test(k)){alert(g.editor.settings.imagevault_pmcm_editorDisabledNoAccessToMedia)}else{alert("Error finding media. "+k)}}else{alert("Cannot find image in ImageVault. It's either removed or you don't have access.")}g.hideSpinner();return}var l=m[0];g.loadPropertyMediaCommon(function(){var o=new ImageVault.PropertyMediaCommon();o.storeEffects=function(q){g.showSpinner(a(g.editor.getContainer()).find(".mceIframeContainer"));var p={Id:l.Id,Effects:q};o.getMedia(p,function(r){if(r===null){alert("Error getting media. "+o.getClient().getLastErrorMessage())}else{g.insertMedia(r)}g.hideSpinner()})};var n=g.parseOriginalAndMedia(l);if(!n){g.hideSpinner();throw"Cannot find original format "+i.stringify(l)}if(!/^image\//i.test(n.OriginalMedia.ContentType)){g.hideSpinner();alert(g.editor.settings.imagevault_pmcm_editorDisabledOriginalFormatNotSupported);return}g.getEffectsFromFormat(n.SelectedMedia.MediaFormatId,n.OriginalMedia,function(p){var q={Original:n.OriginalMedia};var r={Id:l.Id,Effects:p};g.loadFancyBox(function(){o.spinner=g.spinner;g.spinner=null;o.openEditor(q,r)})})})})})},getEffectsFromFormat:function(g,h,f){var i=this;this.getClient(function(j){var l={Filter:{Format:{Id:g}}};var k=JSON.stringify(l);j.json("MediaFormatService/Find",k,function(m){if(m&&m.length){f(i.convertFormatToEffects(m[0],h))}else{alert("Error getting format from server. "+j.getLastErrorMessage())}})})},convertFormatToEffects:function(o,s){var n=o.Effects||[];var u=o.Width;var p=o.Height;var f=o.AspectRatio;var t=s.Width;var r=s.Height;var q=t/r;if(f&&f!=q&&(t>u||r>p)){var i=f*r;var g=t/f;var l=0,m=0,k,j;if(t>i){if(r<p){j=r;k=u}else{k=i;j=r}l=Math.round((t-k)/2)}else{if(t<u){k=t;j=p}else{j=g;k=t}m=Math.round((r-j)/2)}n.push({$type:"ImageVault.Common.Data.Effects.CropEffect,ImageVault.Common",X:l,Y:m,Width:k,Height:j});if(k<=u&&j<=p){return n}}if((u&&u<t)||(p&&p<r)){n.push({$type:"ImageVault.Common.Data.Effects.ResizeEffect,ImageVault.Common",Width:u||0,Height:p||0})}return n}});e.TinyMceOpenEditorButton=d;tinymce.create("tinymce.plugins.ImageVaultPlugin",{init:function(g,k){if(g.settings.extended_valid_elements.indexOf("iframe[")<0){g.settings.extended_valid_elements=g.settings.extended_valid_elements+",iframe[src|width|height|frameborder|name|title|allowfullscreen]"}var j=k.toLowerCase().replace("/util/editor/tinymce/plugins/imagevault","");var f={editor:g,siteUrl:j};var i=new ImageVault.TinyMceAddButton(a.extend({title:"ImageVault",image:k+"/ImageVaultEditorPlugin.png"},f));var h=new ImageVault.TinyMceOpenEditorButton(a.extend({title:"ImageVault Editor",image:k+"/ImageVaultEditorButton.png"},f));i.loadJSON(function(){})},getInfo:function(){return{longname:"ImageVault TinyMCE plugin",author:"Meriworks",authorurl:"http://www.imagevault.se",infourl:"http://www.imagevault.se",version:"4.0"}}});tinymce.PluginManager.add("imagevault",tinymce.plugins.ImageVaultPlugin)})(jQuery,window.ImageVault!=null?window.ImageVault:window.ImageVault={});